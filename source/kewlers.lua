--------------------
-- 1995 / kewlers

kewlers_gfx="000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000e00880000000000000000000000000011010400000000fffffffffff0000000208202000000010000000000080600c04043fe000000020000000000040f01e07fc202000000043ffffffe00021983304041040000000840000001c0311983302080880000000880000001e0791f83f01100700000031898c000013c491f83f00e0000000007bcbde00001e2791f83f0000000180304a4a53fff80c1311f83f00000003c0787bcbde0004000849f83f00000002704831898c0002000425f83f00000003c8780008000001000215f83f80000001843000080000008c0315fc3fc0000002020000100000005e0795fe1fe0000004010000200018c0520494ff0ff000000800800040003de05e07947f87f8000010007fff800025264c03143fc3fc00002000000000003def4401121fe1fe000040000000000039c94401110fe0ff000186180001ffffc20f44010887307f8003cf3c00020000040644010843303fc00249e41f041f0008004a011441e01fe003cf3c3b883b8010004a011440c00fe00186183bf03bffe000440108400007300080081f001f000000401100e0000330008008000000000000202900a00001e00080080000000000001fe900a00000c0008004000000000000003900e0000000008002000000000000001100100000000080011f001f00000002120810000000004000fb803b9818c6051214100000000020003b807bbc3def051214100000000010001f009f242739021208100000000008000001003c3def001200100000000186180002001818c70012001000000003cf3c000400000000801200100000000249241f081f0000004f920f9000000003cf3e3b883b8000005dd21dd00000000186393bf8fb8000005dd3fdd00000000084409f091f0000004f920f90000000010880400a0000000040120010000000021100200a00003006401200100000000422001fca0000780f4012001000000009c406002a0001c8094012001000000012080f1f2a1f02780f4f920f900000001410093baa3b9c30065de21dd000000014200f3baa7bbc00005dc21dd00000001460c61f2a9f2400004f820f9000000014f1e0002a803c000040020010000000149120002a801800004002001000000014f1e0002a80241818400200100000001460c61f2a9f423c3c4f820f9000000014008f3baabb8124245dc21de00000001400893bcabb80fc3c5de21dc000000014008f1f0a9f0018184f920f80000000140087000a8000000040120000000000140081000a801800004013ffffffe000140081000a803c0000401200000010001400e31f0a9f240000401200000008001400f7fb8abbbc00004f920f80000400140094bb8abbd800003dd21dc00002001460f79f0a9f0800001dd21de000010014f063000a800818000f920f90c000c0149001000a80083c0000120011e001e014f001000a800824003fe20011200120146001001280083c0040020011e001e01440021f229f0818008f820f90c000c01440043bc2bb8408011dc21dd08000801440f87b82bb8208023dc43dd08000801441009f029f4108044f884f904000801462010002882088048010801040008014f4010002881888051fe100104000801494010002883c88052002001040010014f46300c2982488054f840f90600e001464f781e2bc3c88055dc81dd0f01e0014449c8322a41888055df0fdd09012001444f785e2bc0088054f810f90f01e0014446308c4980088c540020010600e001444001008880089e54004002180018014440020110800892540047fc3c183c014440040620e0089e54004800243c24014220080840f00c8c54f850f83c243c014110101080907e4055dc51dc183c18014088102700f0922c55de53dc001800014647184800611e1e54f954fa000000014f47bc9000020c1254015401000000014944a4a31804003e54015400980018014f47bca7bc08004c540154007c003c01464318a4a7f0008054f954f82401e401404000a7bc00010055dd55dc3c023c01402000a31800020055dd55dc180418014010012400600c6054f954f800080001200ffe4800f01ef05401542000100001100000900090129094025420181000010800012000f01ef1240c54203c30180107fffe4000700c624410922024783c010000408000080024842111103c48240080004100000800493846088818783c004000420000080092788f08880030180020184600000fff244919088800100000103c4f00000800487a2f0088001000000824490fff080090744618c980300000043c4f100088012044803debc078000002184620004802204500252a40480000010020463038c420c5183debc07800000080108f783de461e53c18c98030000000400f19482524f12527f009000000000020002f783de491e53c000900000000001000463018c4f0c518001100000000000fff8100000460050000210000000070000100800004200500004100000e0088000100400008200500008780f01101040001003ffff0200500010fc1f8208202000100000000200880020cc1984043fe03030000000060704c0e0cc1987fc202078780000000f0f03e1e0cc198404104048480000000909012120fc1f8208088078780000000f0f01e1e0780f011007003030000000060600c0c0000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
kewlers_tex={}
kewlers_voxels={}

kewlers_st=0
function kewlers_init()
	sweetie16_init()
	local y=0
	local x=0
	local j=0
	-- decode texture gfx
	for y=0,127 do
		for x=0,31 do
			local i=y*32+x+1
			local d=tonumber(string.sub(kewlers_gfx,i,i),16)
			for j=0,3 do
				kewlers_tex[y*128+x*4+j+1]=(d&8>>j>0) and 4 or 0
			end
		end
	end

	-- generate voxel shape:
	local ox=-5
	local oy=-5
	local d=3

	local box=function(w,h)
		local z=0
		local x=0
		local y=0
		for z=0,d-1 do
			for x=0,w-1 do
				for y=0,h-1 do
					table.insert(kewlers_voxels,{x=ox+x,y=oy+y,z=z})
				end
			end
		end
		ox=ox+w
	end

	box(3,7)
	box(1,3)
	box(3,14)
	box(1,3)
	box(3,7)
	box(1,3)
	box(3,7)

	kewlers_st = _t
	salad(1,{kiwi,peach,passionfruit,watermelon},2000,1000)
	salad(2,{apple,avocado,blueberry},3000,2000)
	salad(3,{pear,kiwi},2200,2000)
	salad(4,{pineapple,cherry,papaya},5000,2000)
end

function kewlers()
	local t=_t/200
	local a=math.sin(t/23)*3
	local sa=math.sin(a)
	local sa8=math.sin(a+8)
	local panX=math.sin(t/3)*68
	local panY=math.sin(t/5)*68
	local t25=(t*25)//1
	for x=0,239 do
		local uo=(x-120+panX)/136
		local u=uo*sa8+sa
		local usq=u^2
		local f=1/((sa8-uo*sa)*50)
		for y=0,135 do
			local v=(y-68+panY)/136
			local d=1/(usq+v*v)^.5
			local k=(
				(d//f+t25)*128+
				math.atan2(u,v)//.02
			)%16384
			poke4(x,kewlers_tex[k+1]/d+k%.7)
			x=x+240
		end
	end

	local za=t/2
	local sz=math.sin(za)
	local cz=math.cos(za)

	local ya=t/3.5
	local sy=math.sin(ya)
	local cy=math.cos(ya)

	local rw=math.sin(t/6)/4+.8

	for i=1,#kewlers_voxels do
		local v=kewlers_voxels[i]
		local x1,y1,z1=v.x*cz-v.y*sz,v.y*cz+v.x*sz,v.z
		z1,x1=z1*cy-x1*sy,x1*cy+z1*sy
		local z2=(z1+10)/100
		local w=rw/z2
		rect( x1/z2+120, y1/z2+68, w, w, 12)
	end

	overlay_defaults(_t-kewlers_st,"06","1995")
end
